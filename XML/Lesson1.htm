<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
<link href="Lesson1_files/content.css" type="text/css" rel="stylesheet">
<link href="Lesson1_files/catalog.css" type="text/css" rel="stylesheet">
<link href="Lesson1_files/openlessons.css" type="text/css" rel="stylesheet">

<link rel="shortcut icon" href="http://www.avalon.ru/favicon.ico" type="image/x-icon"> 


<meta http-equiv="Content-Language" content="ru">

<link rel="image_src" href="http://img.avalon.ru/Logos/fst4fb.png">
<meta property="og:type" content="company">
<meta property="og:site_name" content="ФПС СПбГПУ">
<meta property="og:image" content="http://img.avalon.ru/Logos/fst4fb.png">
<meta property="fb:admins" content="1085751620">
<meta name="keywords" content="Санкт-Петербург Питер Петербург обучение учеба второе высшее образование диплом свидетельство курсы государственные краткосрочные компьютерные переподготовка дизайн авторизованный Microsoft D-Link Autodesk программирование безопасность профессиональные сертифицированные тестирование сертификация сертификационные экзамены, центр тестирования трудоустройство скидки корпоративный заказчик">
<meta name="description" content="Второе высшее образование, краткосрочные компьютерные курсы, авторизованные курсы, курсы для IT специалистов - обучение в Санкт-Петербурге: Microsoft, Cisco, D-Link, Unix (Linux, FreeBSD, Solaris), Adobe, Autodesk, 1С - Факультет Переподготовки Специалистов (СПбГПУ)">
<!--[if IE]>
	<link rel="stylesheet" type="text/css" href="http://css.avalon.ru/iefix.css" media="all">
<![endif]-->
<link rel="stylesheet" type="text/css" href="Lesson1_files/print.css" media="print">

<script async="" src="Lesson1_files/cbgapi.loaded_0"></script><script type="text/javascript" src="Lesson1_files/FancyZoom.js"></script>
<script type="text/javascript" src="Lesson1_files/FancyZoomHTML.js"></script>
<script type="text/javascript" src="Lesson1_files/jquery.js"></script>
<script type="text/javascript" src="Lesson1_files/flowplayer-3.js"></script>
<script type="text/javascript" src="Lesson1_files/flowplayer.js"></script>

<!-- ���������� ������ �� ������� -->
<script type="text/javascript" src="Lesson1_files/share.js" charset="utf-8"></script>

<!-- Google +1 -->

<script gapi_processed="true" type="text/javascript" src="Lesson1_files/plusone.js">
  {lang: 'ru'}
</script>

<script type="text/javascript" src="Lesson1_files/avalon.js">
</script>

<!-- <������ �����> -->
<script type="text/javascript" src="Lesson1_files/button-top.js"></script>
<link href="Lesson1_files/button-top.css" rel="stylesheet" type="text/css">




<script async="true" src="Lesson1_files/ga.js"></script></head>
	<body><div style="position: absolute; left: 10px; top: 10px; visibility: hidden; z-index: 525;" id="ZoomSpin"><img src="Lesson1_files/zoom-spin-1.png" id="SpinImage"></div><div style="position: absolute; left: 10px; top: 10px; visibility: hidden; z-index: 499; padding: 10px;" id="ZoomBox"><img style="display: block; width: 10px; height: 10px; cursor: pointer;" id="ZoomImage" src="Lesson1_files/spacer.gif" border="0"><div style="position: absolute; right: -15px; top: -15px; visibility: hidden;" id="ZoomClose"><img style="cursor: pointer;" src="Lesson1_files/closebox.png" border="0" height="30" width="30"></div></div><div style="position: absolute; visibility: hidden; margin-left: auto; margin-right: auto; z-index: 501;" id="ZoomCapDiv"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td align="right"><img style="display: block;" src="Lesson1_files/zoom-caption-l.png" height="26" width="13"></td><td style="vertical-align: middle; font-size: 14px; font-family: Helvetica; font-weight: bold; color: rgb(255, 255, 255); text-shadow: 0px 2px 4px rgb(0, 0, 0); white-space: nowrap;" id="ZoomCaption" background="Lesson1_files/zoom-caption-fill.png"></td><td><img style="display: block;" src="Lesson1_files/zoom-caption-r.png" height="26" width="13"></td></tr></tbody></table></div><div style="position: absolute; left: 50px; top: 50px; width: 100px; height: 100px; visibility: hidden; z-index: 498;" id="ShadowBox"><table border="0" cellpadding="0" cellspacing="0" height="100%" width="100%"><tbody><tr style="height: 25px;"><td style="width: 27px;"><img style="display: block;" src="Lesson1_files/zoom-shadow1.png" height="25" width="27"></td><td background="Lesson1_files/zoom-shadow2.png"><img style="display: block;" src="Lesson1_files/spacer.gif" height="1" width="1"></td><td style="width: 27px;"><img style="display: block;" src="Lesson1_files/zoom-shadow3.png" height="25" width="27"></td></tr><tr><td background="Lesson1_files/zoom-shadow4.png"><img style="display: block;" src="Lesson1_files/spacer.gif" height="1" width="1"></td><td bgcolor="#ffffff"><img style="display: block;" src="Lesson1_files/spacer.gif" height="1" width="1"></td><td background="Lesson1_files/zoom-shadow5.png"><img style="display: block;" src="Lesson1_files/spacer.gif" height="1" width="1"></td></tr><tr style="height: 26px;"><td style="width: 27px;"><img style="display: block;" src="Lesson1_files/zoom-shadow6.png" height="26" width="27"></td><td background="Lesson1_files/zoom-shadow7.png"><img style="display: block;" src="Lesson1_files/spacer.gif" height="1" width="1"></td><td style="width: 27px;"><img style="display: block;" src="Lesson1_files/zoom-shadow8.png" height="26" width="27"></td></tr></tbody></table></div>
		<div class="header header-he">
	<div class="header-inner">
		<div class="logo-group">
			<h4>Санкт-Петербургский государственный политехнический университет</h4>
			<div class="logo"><a href="http://www.avalon.ru/"></a></div>
			<h1><span class="f1">Факультет</span><span class="f2">переподготовки</span><span class="f3">специалистов</span></h1>
			<h2>Проект «Открытые уроки»</h2>
		</div>
		<div class="contacts">
			<h2>(812) 703-02-02</h2>
			<h3>Санкт-Петербург, ул. Обручевых, д. 1</h3>
		</div>
		<div id="gcs-form">
		<!-- Google CSE Search Box Begins  -->
		<form action="http://www.avalon.ru/Search/" id="searchbox_004032496792745377532:7aqwhbblfvo">
		  <input name="cx" value="004032496792745377532:7aqwhbblfvo" type="hidden">
		  <input name="cof" value="FORID:11" type="hidden">
		  <input id="gcs-query" name="q" size="20" type="text">

		  <input name="ie" value="utf-8" type="hidden">
		  <input id="gcs-submit" name="sa" value="Найти" type="submit">
		</form>
		<!-- Google CSE Search Box Ends -->
		</div>
	</div>
</div>
 
		<div class="navigationbar">
			

<a href="http://www.avalon.ru/">Главная</a> &gt; <a href="http://www.avalon.ru/OpenLessons/">Открытые уроки</a>
 &gt; <a href="http://www.avalon.ru/OpenLessons/MSSQL/">Microsoft SQL Server 2005</a>
 &gt; Работа с XML
		</div><table class="main">
			<tbody><tr>
				<td class="leftmenu">
					<h1>Общая информация</h1>
<div>
<a href="http://www.avalon.ru/OpenLessons/MSSQL/" title="Аннотация" class="nocurrent">Аннотация</a>
<a href="http://www.avalon.ru/OpenLessons/MSSQL/Forums/" title="Обсуждение" class="nocurrent">Обсуждение</a>
</div>
<h1>Открытые уроки</h1>
<div>
<a href="http://www.avalon.ru/OpenLessons/MSSQL/Lessons/Lesson1/" title="Урок 1. Работа с XML" class="current">Урок 1. Работа с XML</a>
<a href="http://www.avalon.ru/OpenLessons/MSSQL/Lessons/Lesson2/" title="Урок 2. Снимок базы данных" class="nocurrent">Урок 2. Снимок базы данных</a>
<a href="http://www.avalon.ru/OpenLessons/MSSQL/Lessons/Lesson3/" title="Урок 3. Создание схем" class="nocurrent">Урок 3. Создание схем</a>
<a href="http://www.avalon.ru/OpenLessons/MSSQL/Lessons/Lesson4/" title="Урок 4. EXECUTE AS" class="nocurrent">Урок 4. EXECUTE AS</a>

</div>
				</td>
				<td class="content">
					<h1>Работа с XML в MS SQL Server 2005</h1>
					
<h2>Практикум 1. Работа с XML</h2>
<p>Поддержка XML данных была заявлена, и частично реализована еще в 
версии MS SQL Server 2000, 
но имела ряд существенных недостатков, из-за которых активное 
использование этого формата 
данных было затруднительно. Многие из вас знали о дополнительных 
возможностях оператора 
SELECT … FOR XML, позволяющих возвращать выборку в формате XML. 
Но несмотря на довольно большой набор опций форматирования  использовать
 эту конструкцию 
не удавалось слишком часто из-за того, что конструкция  FOR XML не 
допускалась для 
использования в подзапросах. Это и многие другие ограничения, 
связанные с XML данными отсутствуют в новой версии СУБД. MS SQL Server 
2005 позволяет создавать переменные типа xml, использовать 
xml для описания типа столбцов таблиц, связывать с xml данными XSD 
схемы, индексировать xml данные.</p>
<p>Встроенная поддержка XML в СУБД MS SQL Server 2005 позволяет:</p>
<ul>
<li>	Использовать тип данных xml для определения переменных, столбцов таблиц
</li><li>	Определять XSD схемы для автоматической проверки xml данных на структурную корректность 
</li><li>	Извлекать данные в формате xml с помощью улучшенных инструкций FOR XML и OPENXML
</li><li>	Извлечение и модификация xml данные с помощью технологии XQuery
</li><li>	Индексировать xml данные
</li></ul>

<p>Подробно о встроенной поддержке xml в СУБД SQL Server 2005 вы можете узнать на наших курсах<br> 
<a href="http://www.avalon.ru/Courses/Microsoft/Courses/About/?CourseID=441">MOC-2779. Реализация баз данных 
Microsoft SQL Server 2005</a> <br> и <br>
<a href="http://www.avalon.ru/Courses/Microsoft/Courses/About/?CourseID=440">MOC-2734. Обновление навыков 
разработки баз данных до Microsoft SQL Server 2005</a> </p>


<p>В рамках данного практикума мы обсудим следующие темы:</p>
<ul>
<li><a href="#t1">Тема 1. Тип данных xml</a>
</li><li><a href="#t2">Тема 2. Работа с типизированными xml данными</a> 
</li><li><a href="#t3">Тема 3. Использование инструкции FOR XML</a>
</li></ul>

<h3><a name="t1">Тема 1. Тип данных xml</a></h3>
<p>Встроенный тип данных xml позволяет сохранять XML документы или фрагменты XML 
данных в переменных, столбцах таблиц и передавать их в качестве параметров. 
Максимальный объем хранимой информации – 2 Гб. Вы можете связывать с переменными, столбцами 
и параметрами xml типа коллекцию XSD схем, позволяющих проверять XML данные на соответствие 
ожидаемой структуре. Проверка на синтаксическую корректность XML данных происходит 
автоматически и никаких дополнительных настроек не требует. Т.е. допускается 
хранение и обработка только well-formed XML данных.</p>

 
<div class="example">
<h4>Листинг 1.1 Работа с переменными типа xml</h4>
<pre><span class="comment">‘ Объявление переменной</span>
<code>declare @dxml xml
declare @str nvarchar(200)
declare @xmlItem xml
</code>
<span class="comment">‘ Присваивание переменной well-formed фрагмента XML данных</span>
<code>set @dxml='&lt;description&gt;&lt;education&gt;&lt;item&gt;FPS&lt;/item&gt;'
	+'&lt;/education&gt;&lt;/description&gt;'

set @str='&lt;items&gt;&lt;item&gt;Value&lt;/item&gt;&lt;/items&gt;'
set @xmlItem=@str
'или
set @xmlItem=Convert(xml, @str)
</code>
<span class="comment">‘ Создание таблицы </span>
<code>
create table T1(
id int not null primary key,
name varchar(100),
data xml 
)
</code>
<span class="comment">‘ Вставка данных в таблицу</span>
<code>insert into T1 values(1,'Petrov',@dxml)

</code>
</pre>
</div>


<h3><a name="t2">Тема 2. Типизированные xml данные</a></h3>

<p>При формировании xml документов необходимо делать их well-formed, или
 синтаксически корректными. 
Только well-formed документы могут быть обработаны встроенными xml 
процессорами, и сохранены в ячейках таблиц и переменных. 
Кроме того, довольно часто требуется структурная  корректность 
документа, соответствие набора его элементов некоторому шаблону. 
Xml документ является Valid документом, если его структура соответствует
 XSD схеме.  Вы можете связать XSD схему с переменной, 
колонкой или параметром xml типа. Элемент xml типа, с которым связана 
XSD схема, называется типизированным. Связанная с элементом 
схема, будет автоматически проверять его корректность при каждой 
модификации данных. </p> 

<p>Вы можете создать в базе данных коллекции XSD схем, а затем использовать их при описании xml элементов. 
В Листинг 2.1 определяется схема SimpleXmlSchema 
допускающая хранение в одного xml элемента c именем root, и типом хранимых данных string.</p>

<div class="example">
<h4>Листинг 2.1 Создание и использование коллекции схем</h4>
<pre>
<span class="comment">‘ Создание коллекции схем SimpleXmlSchema</span>

<code>create xml schema collection SimpleXmlSchema as
’ &lt;schema xmlns="http://www.w3.org/2001/XMLSchema"&gt;
      &lt;element name="root" type="string"/&gt;
&lt;/schema&gt;’
go <span class="comment">‘ не допускается создание и использование схемы в одном пакете</span>

<span class="comment">‘ Создание типизированной переменной</span>
declare @xmlTypedData xml (SimpleXmlSchema)
set @ xmlTypedData ='&lt;root&gt;Hello&lt;/root&gt;'

<span class="comment">‘ Создание типизированного xml столбца</span>
create table T1(
elem xml (SimpleXmlSchema))

</code>
</pre>
</div>

<p>
Связанная с элементом схема, будет автоматически проверять его корректность при каждой модификации данных. 
В Листинг 2.2 продемонстрированы различные способы  добавление в таблицу xml данных, удовлетворяющих схеме. 
</p>


<div class="example">
<h4>Листинг 2.2 Модификация типизированных xml элементов</h4>
<pre><code>
<span class="comment">‘ Модификация типизированного xml столбца</span>

<span class="comment">‘ строковый фрагмент удовлетворяет схеме</span>
insert into T1 values (‘&lt;root&gt;www.avalon.ru&lt;/root&gt;’)

<span class="comment">‘ типизированная переменная связана с той же схемой, что и столбец таблицы</span>
insert into T1 values (@xmlTypedData) 

<span class="comment">‘ переменная не типизированная, но ее содержимое удовлетворяет схеме</span>
declare @xmlUntypedData
set @xmlUntypedData=’&lt;root&gt;Untyped Xml&lt;/root&gt;’
insert into T1 values (@xmlUntypedData)
</code>
</pre>
</div>


<h3><a name="t3">Тема 3. Использование инструкций FOR XML</a></h3>


<p>
В Microsoft SQL Server 2000 для получения данных в формате XML использовалась инструкция SELECT… FOR XML. 
С помощью этой инструкции возвращаемый SELECT-ом набор данных можно было отформатировать в XML в трех 
различных режимах—RAW, AUTO и EXPLICIT. Однако, результат выполнения инструкции SELECT… FOR XML 
в SQL Server 2000 можно было обрабатывать только на клиентской стороне, нельзя было использовать в подзапросах, 
как параметры хранимых процедур и использование опции FOR XML EXPLICIT для создания сложных структур xml данных 
было непростой задачей. В 2005 версии ряд 
ограничений был снят и появились новые, расширенные возможности форматирования.
</p>

<p>
Самым простым режимом выборки данных в формате xml является опции FOR XML RAW. 
Для каждой возвращаемой строки создается один элемент с именем raw по умолчанию. Вы можете 
переименовать элемент raw, добавить корневой элемент к выборке, переопределить структуру.
</p>




<!-- Начало образца -->

<div class="example">
<h4>Листинг 3.1 Использование режима FOR XML RAW</h4>
<pre><code><span class="comment">‘ форматирование выборки по умолчанию</span>
<span class="comment">‘ простая выборка из одной таблицы</span>
use AdwentureWorks
select CustomerID, TerritoryID, CustomerType
from Sales.Customer
where CustomerID=1 or CustomerID=2
FOR XML RAW</code>
</pre>
<div class="result">
<h5>Результат :</h5>
<pre><code>
&lt;row CustomerID="1" TerritoryID="1" CustomerType="S" /&gt;
&lt;row CustomerID="2" TerritoryID="1" CustomerType="S" /&gt;</code>
</pre>
</div>
</div>


<div class="example">
<h4>Листинг 3.2 Использование режима FOR XML RAW</h4>
<pre><code><span class="comment">‘ форматирование выборки по умолчанию</span>
<span class="comment">‘ выборка из двух связанных таблиц</span>
use AdwentureWorks
select s.SalesoRDERid, c.CustomerID, 
	c.CustomerType, s.OrderDate, s.Status
from Sales.Customer c 
	inner join Sales.SalesOrderHeader s
on c.CustomerID=s.CustomerID
where c.CustomerID=1 or c.CustomerID=442
FOR XML RAW</code>
</pre>
<div class="result">
<h5>Результат (фрагмент):</h5>
<pre>&lt;row SalesoRDERid="45283" CustomerID="1" CustomerType="S" <br> OrderDate="2002-02-01T00:00:00" Status="5" /&gt;
&lt;row SalesoRDERid="46042" CustomerID="1" CustomerType="S" <br> OrderDate="2002-05-01T00:00:00" Status="5" /&gt;
&lt;row SalesoRDERid="43661" CustomerID="442" CustomerType="S" <br> OrderDate="2001-07-01T00:00:00" Status="5" /&gt;
&lt;row SalesoRDERid="44282" CustomerID="442" CustomerType="S" <br> OrderDate="2001-10-01T00:00:00" Status="5" /&gt;
</pre>
</div>
</div>

<!-- конец образца -->


<div class="example">
<h4>Листинг 3.3 Использование режима FOR XML RAW, ROOT</h4>
<pre><span class="comment">
'добавление корневого элемента 'Customers', переименование строчного элемента</span>
<span class="comment">‘ простая выборка из одной таблицы</span>
use AdwentureWorks
select CustomerID, TerritoryID, CustomerType
from Sales.Customer
where CustomerID=1 or CustomerID=2
FOR XML RAW('Cust'), root('Customers')
</pre>
<div class="result">
<h5>Результат (фрагмент):</h5>
<pre>	
&lt;Customers&gt;
  &lt;Cust CustomerID="1" TerritoryID="1" CustomerType="S" /&gt;
  &lt;Cust CustomerID="2" TerritoryID="1" CustomerType="S" /&gt;
&lt;/Customers&gt;
</pre>
</div>
</div>

<div class="example">
<h4>Листинг 3.4 Использование режима FOR XML RAW, ROOT, ELEMENTS</h4>
<pre><span class="comment">‘ значения колонок форматируются как вложенные подэлементы</span>
<span class="comment">‘ простая выборка из одной таблицы</span>
select CustomerID, TerritoryID, CustomerType
from Sales.Customer
where CustomerID=1 or CustomerID=2
FOR XML RAW('Cust'),root('Customers'), ELEMENTS

</pre>
<div class="result">
<h5>Результат (фрагмент):</h5>
<pre>&lt;Customers&gt;
  &lt;Cust&gt;
    &lt;CustomerID&gt;1&lt;/CustomerID&gt;
    &lt;TerritoryID&gt;1&lt;/TerritoryID&gt;
    &lt;CustomerType&gt;S&lt;/CustomerType&gt;
  &lt;/Cust&gt;
  &lt;Cust&gt;
    &lt;CustomerID&gt;2&lt;/CustomerID&gt;
    &lt;TerritoryID&gt;1&lt;/TerritoryID&gt;
    &lt;CustomerType&gt;S&lt;/CustomerType&gt;
  &lt;/Cust&gt;
&lt;/Customers&gt;
</pre>
</div>
</div>


<div class="example">
<h4>Листинг 3.5 Использование режима FOR XML RAW, ROOT, ELEMENTS</h4>
<pre><span class="comment">‘ выборка из двух связанных таблиц</span>
<span class="comment">‘ столбцы дочерней таблицы выводятся как вложенные элементы</span>
use AdwentureWorks

select s.SalesoRDERid, c.CustomerID, 
	c.CustomerType, s.OrderDate, s.Status
from Sales.Customer c 
	inner join Sales.SalesOrderHeader s
on c.CustomerID=s.CustomerID
where c.CustomerID=1 or c.CustomerID=442
FOR XML RAW('Order'), root('Orders'), ELEMENTS
</pre>
<div class="result">
<h5>Результат (фрагмент):</h5>
<pre>&lt;Orders&gt;
&lt;Order&gt;
    &lt;SalesoRDERid&gt;45283&lt;/SalesoRDERid&gt;
    &lt;CustomerID&gt;1&lt;/CustomerID&gt;
    &lt;CustomerType&gt;S&lt;/CustomerType&gt;
    &lt;OrderDate&gt;2002-02-01T00:00:00&lt;/OrderDate&gt;
    &lt;Status&gt;5&lt;/Status&gt;
  &lt;/Order&gt;
  &lt;Order&gt;
    &lt;SalesoRDERid&gt;46042&lt;/SalesoRDERid&gt;
    &lt;CustomerID&gt;1&lt;/CustomerID&gt;
    &lt;CustomerType&gt;S&lt;/CustomerType&gt;
    &lt;OrderDate&gt;2002-05-01T00:00:00&lt;/OrderDate&gt;
    &lt;Status&gt;5&lt;/Status&gt;
  &lt;/Order&gt;
  &lt;Order&gt;
    &lt;SalesoRDERid&gt;43661&lt;/SalesoRDERid&gt;
    &lt;CustomerID&gt;442&lt;/CustomerID&gt;
    &lt;CustomerType&gt;S&lt;/CustomerType&gt;
    &lt;OrderDate&gt;2001-07-01T00:00:00&lt;/OrderDate&gt;
    &lt;Status&gt;5&lt;/Status&gt;
  &lt;/Order&gt;
  &lt;Order&gt;
    &lt;SalesoRDERid&gt;44282&lt;/SalesoRDERid&gt;
    &lt;CustomerID&gt;442&lt;/CustomerID&gt;
    &lt;CustomerType&gt;S&lt;/CustomerType&gt;
    &lt;OrderDate&gt;2001-10-01T00:00:00&lt;/OrderDate&gt;
    &lt;Status&gt;5&lt;/Status&gt;
  &lt;/Order&gt;
&lt;/Orders&gt;
</pre>
</div>
</div>

<p>
Режим FOR XML AUTO позволяет сформировать простейший xml фрагмент с вложенными элементами. 
Имена элементов и уровень вложенности генерируется на основе именования и отношений между объектами в БД. 
</p>

<div class="example">
<h4>Листинг 3.6 Использование режима FOR XML AUTO</h4>
<pre><span class="comment">‘форматирование выборки в режиме FOR XML AUTO по умолчанию</span>
<span class="comment">‘простая выборка из одной таблицы</span>
<span class="comment">‘столбцы отображаются в атрибуты</span>
use AdwentureWorks

select CustomerID, TerritoryID, CustomerType
from Sales.Customer
where CustomerID=1 or CustomerID=2
FOR XML AUTO
</pre>
<div class="result">
<h5>Результат:</h5>
<pre>&lt;Sales.Customer CustomerID="1" TerritoryID="1" CustomerType="S" /&gt;
&lt;Sales.Customer CustomerID="2" TerritoryID="1" CustomerType="S" /&gt;
</pre>
</div>
</div>


<div class="example">
<h4>Листинг 3.7 Использование режима FOR XML AUTO</h4>
<pre><code><span class="comment">‘форматирование выборки в режиме FOR XML AUTO по умолчанию</span>
<span class="comment">‘выборка из двух связанных таблиц</span>
<span class="comment">‘столбцы отображаются в атрибуты </span>
<span class="comment">‘2 уровня вложенности элеменетов содержат соответствующие столбцы</span>
<span class="comment">‘родительской и дочерней таблиц</span>

use AdwentureWorks

select s.SalesoRDERid, c.CustomerID, 
	c.CustomerType, s.OrderDate, s.Status
from Sales.Customer c 
	inner join Sales.SalesOrderHeader s
on c.CustomerID=s.CustomerID
where c.CustomerID=1
FOR XML AUTO</code>
</pre>
<div class="result">
<h5>Результат:</h5>
<pre><code>
&lt;s SalesoRDERid="43860" OrderDate="2001-08-01T00:00:00" Status="5"&gt;
  &lt;c CustomerID="1" CustomerType="S" /&gt;
&lt;/s&gt;
&lt;s SalesoRDERid="44501" OrderDate="2001-11-01T00:00:00" Status="5"&gt;
  &lt;c CustomerID="1" CustomerType="S" /&gt;
&lt;/s&gt;
&lt;s SalesoRDERid="45283" OrderDate="2002-02-01T00:00:00" Status="5"&gt;
  &lt;c CustomerID="1" CustomerType="S" /&gt;
&lt;/s&gt;
&lt;s SalesoRDERid="46042" OrderDate="2002-05-01T00:00:00" Status="5"&gt;
  &lt;c CustomerID="1" CustomerType="S" /&gt;
&lt;/s&gt;</code>
</pre>
</div>
</div>

<div class="example">
<h4>Листинг 3.8 Использование режима FOR XML AUTO, ELEMENTS</h4>
<pre><code><span class="comment">‘форматирование выборки в режиме FOR XML AUTO, ELEMENTS</span>
<span class="comment">‘выборка из двух связанных таблиц</span>  
<span class="comment">‘значения столбцов форматируются как вложенные подэлементы</span>
use AdwentureWorks

select s.SalesoRDERid, c.CustomerID, 
	c.CustomerType, s.OrderDate, s.Status
from Sales.Customer c 
	inner join Sales.SalesOrderHeader s
on c.CustomerID=s.CustomerID
where c.CustomerID=1
FOR XML AUTO, ELEMENTS</code>
</pre>

<div class="result">
<h5>Результат:</h5>
<pre><code>
&lt;s&gt;
  &lt;SalesoRDERid&gt;43860&lt;/SalesoRDERid&gt;
  &lt;OrderDate&gt;2001-08-01T00:00:00&lt;/OrderDate&gt;
  &lt;Status&gt;5&lt;/Status&gt;
  &lt;c&gt;
    &lt;CustomerID&gt;1&lt;/CustomerID&gt;
    &lt;CustomerType&gt;S&lt;/CustomerType&gt;
  &lt;/c&gt;
&lt;/s&gt;</code>
</pre>
</div></div>
<p>
Режим FOR XML AUTO в сочетании с опцией TYPE позволяет избежать 
использования режима FOR XML EXPLICIT для формирования простых вложенных выборок. 
Опция TYPE прзволяет вывести результат выборки в формате xml. 
</p>


<div class="example">
<h4>Листинг 3.9 Использование режима FOR XML AUTO, TYPE для сложного форматирования</h4>
<pre><code><span class="comment">‘ для каждого заказчика выводятся номера заказов и</span>
<span class="comment">‘ имена сотрудников, оформлявших эти заказы</span>
<span class="comment">‘ данные группируются внутри одного элемента и форматируются</span> 
<span class="comment">‘ в соответствии с правилами режима FOR XML AUTO</span>
select 
(select s.SalesoRDERid
from Sales.SalesOrderHeader s 
where c.CustomerID=s.CustomerID
for xml auto, type),
c.CustomerID, 
c.CustomerType,
(select distinct pc.LastName
from Person.Contact pc 
inner join Sales.SalesOrderHeader s 
on s.SalesPersonID=pc.ContactID
where pc.ContactID=s.SalesPersonID AND 
	c.CustomerID=s.CustomerID
for xml auto, type)
from Sales.Customer c
where c.CustomerID=22
for xml auto, type</code>
</pre>

<div class="result">
<h5>Результат:</h5>
<pre><code>
&lt;c CustomerID="22" CustomerType="S"&gt;
  &lt;s SalesoRDERid="43874" /&gt;
  &lt;s SalesoRDERid="44519" /&gt;
  &lt;s SalesoRDERid="46989" /&gt;
  &lt;s SalesoRDERid="48013" /&gt;
  &lt;s SalesoRDERid="49130" /&gt;
  &lt;s SalesoRDERid="50274" /&gt;
  &lt;s SalesoRDERid="51807" /&gt;
  &lt;s SalesoRDERid="57113" /&gt;
  &lt;s SalesoRDERid="63162" /&gt;
  &lt;s SalesoRDERid="69495" /&gt;
  &lt;pc LastName="Dusza" /&gt;
  &lt;pc LastName="Ecoffey" /&gt;
&lt;/c&gt;</code>
</pre>
</div></div>

<p>В некоторых ситуациях, нестандартного форматирование xml фрагмента можно добиться с помощью режима FOR XML PATH.</p>

<div class="example">
<h4>Листинг 3.10 Использование режима FOR XML PATH</h4>
<pre><code><span class="comment">‘для каждого заказчика формируется элемент 'Cust', </span>
<span class="comment">‘значение из столбца CustomerID выводится в виде атрибуты 'CustID'</span>
select CustomerID as "@CustID", 
TerritoryID, 
CustomerType
from Sales.Customer
where c.CustomerID=1 or c.CustomerID=442
for xml path('Cust')
</code>
</pre>

<div class="result">
<h5>Результат:</h5>
<pre><code>
&lt;Cust CustID="1"&gt;
  &lt;TerritoryID&gt;1&lt;/TerritoryID&gt;
  &lt;CustomerType&gt;S&lt;/CustomerType&gt;
&lt;/Cust&gt;
&lt;Cust CustID="442"&gt;
  &lt;TerritoryID&gt;6&lt;/TerritoryID&gt;
  &lt;CustomerType&gt;S&lt;/CustomerType&gt;
&lt;/Cust&gt;</code></pre>
</div>
</div>

<div class="example">
<h4>Листинг 3.11 Использование режима FOR XML PATH, TYPE</h4>
<pre><span class="comment">‘ формирование сложной выборки такого же формата,</span>
<code><span class="comment">‘как в Листинге 3.6 в режиме FOR XML PATH, TYPE</span>
select
c.CustomerID as "@custID", 
c.CustomerType as "@custType",
(select s.SalesoRDERid as "@orderID"
from Sales.SalesOrderHeader s 
where c.CustomerID=s.CustomerID
for xml path('Order'), type),
(select distinct pc.LastName as "@LastName"
from Person.Contact pc 
inner join Sales.SalesOrderHeader s 
on s.SalesPersonID=pc.ContactID
where pc.ContactID=s.SalesPersonID 
	AND c.CustomerID=s.CustomerID
for xml path('Person'), type)
from Sales.Customer c
where c.CustomerID=22
for xml path('customer'), type
</code></pre>

<div class="result">
<h5>Результат:</h5>
<pre><code>
&lt;customer custID="22" custType="S"&gt;
  &lt;Order orderID="43874" /&gt;
  &lt;Order orderID="44519" /&gt;
  &lt;Order orderID="46989" /&gt;
  &lt;Order orderID="48013" /&gt;
  &lt;Order orderID="49130" /&gt;
  &lt;Order orderID="50274" /&gt;
  &lt;Order orderID="51807" /&gt;
  &lt;Order orderID="57113" /&gt;
  &lt;Order orderID="63162" /&gt;
  &lt;Order orderID="69495" /&gt;
  &lt;Person LastName="Dusza" /&gt;
  &lt;Person LastName="Ecoffey" /&gt;
&lt;/customer&gt;</code>
</pre>
</div>
</div>



					
				</td>
			</tr>
		</tbody></table>
		<!-- <Кнопка Наверх> --><div style="display: none;" id="back-top"><a title="Наверх" id="back-top-a" href="#"> </a></div>

<div class="copyright">
	<p class="f-left">
		<span><a href="http://www.avalon.ru/" class="logo-sml">&nbsp;</a></span>
		<span><a href="http://www.avalon.ru/About/Officials/">Официальные лица</a></span>
		<span><a href="http://www.avalon.ru/About/Events/" class="icon-lc icon-calendar">Календарь событий</a></span>
		<span><a href="http://vkontakte.ru/avalon_ru" class="icon-lc icon-vkontakte" target="_blank" title="ФПС Вконтакте"></a>&nbsp;<a href="http://www.facebook.com/avalon.ru" class="icon-lc icon-facebook" target="_blank" title="ФПС на Facebook"></a>&nbsp;<a href="http://twitter.com/avalon_ru/" class="icon-lc icon-twitter" target="_blank" title="ФПС в Twitter"></a></span>
	</p>
	<p class="f-right">
		<span><a href="http://www.avalon.ru/About/Address/">Санкт-Петербург, ул. Обручевых, д. 1</a></span>
		<span><em class="icon-lc icon-phone">&nbsp;</em>+7 (812) 703-02-02</span>
	</p>
</div>


	<div class="counters">

	<!-- Yandex.Metrika counter -->
<div style="display:none;"><script type="text/javascript">
(function(w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter114582 = new Ya.Metrika({id:114582,
                    clickmap:true,
                    trackLinks:true});
        }
        catch(e) { }
    });
})(window, 'yandex_metrika_callbacks');
</script></div>
<script src="Lesson1_files/watch_visor.js" type="text/javascript" defer="defer"></script>
<noscript><div><img src="//mc.yandex.ru/watch/114582" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

	<!-- Google -->
	<script type="text/javascript">

	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-308944-1']);
	  _gaq.push(['_trackPageview']);

	  (function() {
		var ga = document.createElement('script');
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		ga.setAttribute('async', 'true');
		document.documentElement.firstChild.appendChild(ga);
	  })();

	</script>
	<!-- /Google -->

	</div>


	
</body></html>